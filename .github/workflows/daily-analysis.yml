name: Daily Market Analysis

on:
  # Run at 4:30 PM ET (21:30 UTC) on weekdays
  schedule:
    - cron: '30 21 * * 1-5'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      symbols:
        description: 'Comma-separated symbols (leave empty for default)'
        required: false
        default: ''

# Prevent concurrent runs
concurrency:
  group: market-analysis
  cancel-in-progress: false

# Required for creating releases
permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync

      - name: Check if trading day
        id: trading-day
        env:
          IS_MANUAL: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          python3 << 'EOF'
          import os
          from datetime import datetime

          HOLIDAYS_2026 = [
              "2026-01-01", "2026-01-19", "2026-02-16", "2026-04-03",
              "2026-05-25", "2026-06-19", "2026-07-03", "2026-09-07",
              "2026-11-26", "2026-12-25"
          ]

          is_manual = os.environ.get("IS_MANUAL", "false") == "true"
          today_dt = datetime.now()
          today = today_dt.strftime("%Y-%m-%d")
          weekday = today_dt.weekday()

          if is_manual:
              is_trading_day = True
              reason = "Manual trigger"
          elif weekday >= 5:
              is_trading_day = False
              reason = "Weekend"
          elif today in HOLIDAYS_2026:
              is_trading_day = False
              reason = f"Holiday ({today})"
          else:
              is_trading_day = True
              reason = "Trading day"

          print(f"{reason} - {today}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"is_trading_day={str(is_trading_day).lower()}\n")
              f.write(f"skip_reason={reason}\n")
          EOF

      - name: Run market analysis
        id: analysis
        if: ${{ steps.trading-day.outputs.is_trading_day == 'true' }}
        run: |
          echo "Starting market analysis at $(date)"
          uv run python analyze_market.py
          echo "Analysis completed at $(date)"
          echo "date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          echo "json_file=results/latest.json" >> $GITHUB_OUTPUT

      - name: Extract summary for notification
        id: summary
        if: ${{ steps.trading-day.outputs.is_trading_day == 'true' }}
        run: |
          python3 << 'EOF'
          import json
          import os

          with open("results/latest.json") as f:
              data = json.load(f)

          market = data.get("market_overview", {})
          candidates = data.get("strong_candidates", [])[:5]

          summary_lines = [
              f"**Sentiment:** {market.get('sentiment', 'N/A')} ({market.get('bullish_pct', 0):.1f}% bullish)",
              "",
              "**Top Picks:**",
          ]

          for c in candidates:
              summary_lines.append(
                  f"- **{c['symbol']}** | {c['trend_direction']} | Mom: {c['momentum_score']:+.2f} | Alpha: {c['composite_score']:+.2f}"
              )

          summary = "\n".join(summary_lines)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write("summary<<EOF\n")
              f.write(summary)
              f.write("\nEOF\n")

          print(summary)
          EOF

      - name: Create GitHub Release
        if: ${{ steps.trading-day.outputs.is_trading_day == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          DATE="${{ steps.analysis.outputs.date }}"
          TAG="analysis-${DATE}"

          gh release create "$TAG" \
            --title "ðŸ“Š Market Analysis - ${DATE}" \
            --notes-file results/SUMMARY.md \
            results/latest.json \
            results/alpha_rankings.csv

      # Optional: Send Slack notification
      - name: Send Slack notification
        if: ${{ steps.trading-day.outputs.is_trading_day == 'true' && vars.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "Daily Market Analysis - ${{ steps.analysis.outputs.date }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ“Š Daily Market Analysis - ${{ steps.analysis.outputs.date }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.summary.outputs.summary }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View full results>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # Optional: Send email via SendGrid
      - name: Send email notification
        if: ${{ steps.trading-day.outputs.is_trading_day == 'true' && vars.SENDGRID_API_KEY != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.sendgrid.net
          server_port: 587
          username: apikey
          password: ${{ secrets.SENDGRID_API_KEY }}
          subject: "Daily Market Analysis - ${{ steps.analysis.outputs.date }}"
          to: ${{ vars.NOTIFICATION_EMAIL }}
          from: ${{ vars.SENDER_EMAIL }}
          body: |
            Daily Market Analysis Report
            ============================

            ${{ steps.summary.outputs.summary }}

            View full results: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          attachments: ${{ steps.analysis.outputs.json_file }}

      - name: Create summary
        if: ${{ steps.trading-day.outputs.is_trading_day == 'true' }}
        run: |
          echo "## ðŸ“Š Market Analysis - ${{ steps.analysis.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.summary.outputs.summary }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Results:** [View Release](../releases/tag/analysis-${{ steps.analysis.outputs.date }})" >> $GITHUB_STEP_SUMMARY

      - name: Create summary (skipped)
        if: ${{ steps.trading-day.outputs.is_trading_day != 'true' }}
        run: |
          echo "## ðŸ“Š Market Analysis - Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Reason: ${{ steps.trading-day.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
